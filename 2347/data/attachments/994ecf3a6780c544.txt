[32mINFO    [0m integration.test_backups:test_backups.py:80 deleting the previously created backups
[32mINFO    [0m pytest_operator.plugin:plugin.py:862 Model status:

Model  Controller          Cloud/Region        Version  SLA          Timestamp
test   microk8s-localhost  microk8s/localhost  3.1.8    unsupported  01:59:26Z

App                       Version  Status   Scale  Charm                     Channel        Rev  Address         Exposed  Message
postgresql-k8s-gcp        14.11    waiting      2  postgresql-k8s                             1  10.152.183.184  no       installing agent
s3-integrator                      active       1  s3-integrator             latest/stable   17  10.152.183.216  no       
self-signed-certificates           active       1  self-signed-certificates  latest/stable   72  10.152.183.102  no       

Unit                         Workload     Agent      Address      Ports  Message
postgresql-k8s-gcp/0         active       executing  10.1.178.81         
postgresql-k8s-gcp/1*        maintenance  idle       10.1.178.82         checking stanza
s3-integrator/0*             active       idle       10.1.178.72         
self-signed-certificates/0*  active       idle       10.1.178.73         

[32mINFO    [0m pytest_operator.plugin:plugin.py:868 Juju error logs:

unit-postgresql-k8s-gcp-0: 01:57:25 ERROR unit.postgresql-k8s-gcp/0.juju-log database-peers:6: failed to change plugins: 
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 301, in enable_disable_extensions
    with self._connect_to_database() as connection, connection.cursor() as cursor:
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 128, in _connect_to_database
    connection = psycopg2.connect(
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/venv/psycopg2/__init__.py", line 122, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "postgresql-k8s-gcp-primary.test.svc.cluster.local" (10.152.183.169), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/./src/charm.py", line 551, in enable_disable_extensions
    self.postgresql.enable_disable_extensions(extensions, database)
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/lib/charms/postgresql_k8s/v0/postgresql.py", line 325, in enable_disable_extensions
    raise PostgreSQLEnableDisableExtensionError()
charms.postgresql_k8s.v0.postgresql.PostgreSQLEnableDisableExtensionError
unit-postgresql-k8s-gcp-0: 01:58:55 ERROR unit.postgresql-k8s-gcp/0.juju-log non-zero exit code 56 executing ['pgbackrest', '--stanza=test.patroni-postgresql-k8s-gcp', '--log-level-console=debug', '--type=full', 'backup'], stdout='2024-05-27 01:58:54.340 P00  DEBUG:     common/io/socket/common::sckInit: (block: false, keepAlive: true, tcpKeepAliveCount: 0, tcpKeepAliveIdle: 0, tcpKeepAliveInterval: 0)\n2024-05-27 01:58:54.340 P00  DEBUG:     common/io/socket/common::sckInit: => void\n2024-05-27 01:58:54.341 P00   INFO: backup command begin 2.48: --backup-standby --exec-id=4009-a9a68ec0 --log-level-console=debug --pg2-host=postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints --pg2-host-ca-file=/var/lib/postgresql/data/ca.pem --pg2-host-cert-file=/var/lib/postgresql/data/cert.pem --pg2-host-key-file=/var/lib/postgresql/data/key.pem --pg2-host-type=tls --pg1-path=/var/lib/postgresql/data/pgdata --pg2-path=/var/lib/postgresql/data/pgdata --pg1-user=backup --pg2-user=backup --repo1-block --repo1-bundle --repo1-path=/postgresql-k8s/e19b9a69-1bc8-11ef-8e2e-e3e158adddd3 --repo1-retention-full=9999999 --repo1-retention-full-type=time --repo1-retention-history=365 --repo1-s3-bucket=data-charms-testing --repo1-s3-endpoint=https://storage.googleapis.co' [truncated], stderr="WARN: unable to check pg2: [LockAcquireError] raised from remote-0 tls protocol on 'postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints': unable to acquire lock on file '/tmp/pgbackrest/test.patroni-postgresql-k8s-gcp-backup.lock': Resource temporarily unavailable\n      HINT: is another pgBackRest process running?\nERROR: [056]: unable to find primary cluster - cannot proceed\n       HINT: are all available clusters in recovery?\n       --------------------------------------------------------------------\n       If SUBMITTING AN ISSUE please provide the following information:\n       \n       version: 2.48\n       command: backup\n       options: --backup-standby --exec-id=4009-a9a68ec0 --log-level-console=debug --pg2-host=postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints --pg2-host-ca-file=/var/lib/postgresql/data/ca.pem --pg2-host-cert-file=/var/lib/postgresql/data/cert.pem --pg2-host-key-file=/var/lib/postgresql/data/key.pem --pg2-host-type=tls --pg1-path=/var/lib/postgresql/data/pgdata --pg2-path=/var/lib/postgresq" [truncated]
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/src/backups.py", line 540, in _on_create_backup_action
    stdout, stderr = self._execute_command(command)
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/src/backups.py", line 235, in _execute_command
    ).wait_output()
  File "/var/lib/juju/agents/unit-postgresql-k8s-gcp-0/charm/venv/ops/pebble.py", line 1559, in wait_output
    raise ExecError[AnyStr](self._command, exit_code, out_value, err_value)
ops.pebble.ExecError: non-zero exit code 56 executing ['pgbackrest', '--stanza=test.patroni-postgresql-k8s-gcp', '--log-level-console=debug', '--type=full', 'backup'], stdout='2024-05-27 01:58:54.340 P00  DEBUG:     common/io/socket/common::sckInit: (block: false, keepAlive: true, tcpKeepAliveCount: 0, tcpKeepAliveIdle: 0, tcpKeepAliveInterval: 0)\n2024-05-27 01:58:54.340 P00  DEBUG:     common/io/socket/common::sckInit: => void\n2024-05-27 01:58:54.341 P00   INFO: backup command begin 2.48: --backup-standby --exec-id=4009-a9a68ec0 --log-level-console=debug --pg2-host=postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints --pg2-host-ca-file=/var/lib/postgresql/data/ca.pem --pg2-host-cert-file=/var/lib/postgresql/data/cert.pem --pg2-host-key-file=/var/lib/postgresql/data/key.pem --pg2-host-type=tls --pg1-path=/var/lib/postgresql/data/pgdata --pg2-path=/var/lib/postgresql/data/pgdata --pg1-user=backup --pg2-user=backup --repo1-block --repo1-bundle --repo1-path=/postgresql-k8s/e19b9a69-1bc8-11ef-8e2e-e3e158adddd3 --repo1-retention-full=9999999 --repo1-retention-full-type=time --repo1-retention-history=365 --repo1-s3-bucket=data-charms-testing --repo1-s3-endpoint=https://storage.googleapis.co' [truncated], stderr="WARN: unable to check pg2: [LockAcquireError] raised from remote-0 tls protocol on 'postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints': unable to acquire lock on file '/tmp/pgbackrest/test.patroni-postgresql-k8s-gcp-backup.lock': Resource temporarily unavailable\n      HINT: is another pgBackRest process running?\nERROR: [056]: unable to find primary cluster - cannot proceed\n       HINT: are all available clusters in recovery?\n       --------------------------------------------------------------------\n       If SUBMITTING AN ISSUE please provide the following information:\n       \n       version: 2.48\n       command: backup\n       options: --backup-standby --exec-id=4009-a9a68ec0 --log-level-console=debug --pg2-host=postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints --pg2-host-ca-file=/var/lib/postgresql/data/ca.pem --pg2-host-cert-file=/var/lib/postgresql/data/cert.pem --pg2-host-key-file=/var/lib/postgresql/data/key.pem --pg2-host-type=tls --pg1-path=/var/lib/postgresql/data/pgdata --pg2-path=/var/lib/postgresq" [truncated]
unit-postgresql-k8s-gcp-0: 01:58:56 ERROR unit.postgresql-k8s-gcp/0.juju-log Backup failed: Failed to backup PostgreSQL with error: non-zero exit code 56 executing ['pgbackrest', '--stanza=test.patroni-postgresql-k8s-gcp', '--log-level-console=debug', '--type=full', 'backup'], stdout='2024-05-27 01:58:54.340 P00  DEBUG:     common/io/socket/common::sckInit: (block: false, keepAlive: true, tcpKeepAliveCount: 0, tcpKeepAliveIdle: 0, tcpKeepAliveInterval: 0)\n2024-05-27 01:58:54.340 P00  DEBUG:     common/io/socket/common::sckInit: => void\n2024-05-27 01:58:54.341 P00   INFO: backup command begin 2.48: --backup-standby --exec-id=4009-a9a68ec0 --log-level-console=debug --pg2-host=postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints --pg2-host-ca-file=/var/lib/postgresql/data/ca.pem --pg2-host-cert-file=/var/lib/postgresql/data/cert.pem --pg2-host-key-file=/var/lib/postgresql/data/key.pem --pg2-host-type=tls --pg1-path=/var/lib/postgresql/data/pgdata --pg2-path=/var/lib/postgresql/data/pgdata --pg1-user=backup --pg2-user=backup --repo1-block --repo1-bundle --repo1-path=/postgresql-k8s/e19b9a69-1bc8-11ef-8e2e-e3e158adddd3 --repo1-retention-full=9999999 --repo1-retention-full-type=time --repo1-retention-history=365 --repo1-s3-bucket=data-charms-testing --repo1-s3-endpoint=https://storage.googleapis.co' [truncated], stderr="WARN: unable to check pg2: [LockAcquireError] raised from remote-0 tls protocol on 'postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints': unable to acquire lock on file '/tmp/pgbackrest/test.patroni-postgresql-k8s-gcp-backup.lock': Resource temporarily unavailable\n      HINT: is another pgBackRest process running?\nERROR: [056]: unable to find primary cluster - cannot proceed\n       HINT: are all available clusters in recovery?\n       --------------------------------------------------------------------\n       If SUBMITTING AN ISSUE please provide the following information:\n       \n       version: 2.48\n       command: backup\n       options: --backup-standby --exec-id=4009-a9a68ec0 --log-level-console=debug --pg2-host=postgresql-k8s-gcp-1.postgresql-k8s-gcp-endpoints --pg2-host-ca-file=/var/lib/postgresql/data/ca.pem --pg2-host-cert-file=/var/lib/postgresql/data/cert.pem --pg2-host-key-file=/var/lib/postgresql/data/key.pem --pg2-host-type=tls --pg1-path=/var/lib/postgresql/data/pgdata --pg2-path=/var/lib/postgresq" [truncated]

[32mINFO    [0m pytest_operator.plugin:plugin.py:947 Forgetting model main...